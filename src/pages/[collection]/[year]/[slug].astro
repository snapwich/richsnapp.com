---
import { getCollection, render } from "astro:content";
import BlogPage from "layouts/BlogPage.astro";
import Disqus from "components/Disqus.astro";
import { parseSlugDate } from "utils/date";
import { createMD5Hash } from "utils/crypto";
import { markdownToHtml, getFirstParagraph } from "utils/blurb";

export async function getStaticPaths() {
  const blogPosts = await getCollection("blog");
  const articlePosts = await getCollection("article");
  const combinedPosts = [...blogPosts, ...articlePosts];
  return combinedPosts.map((post) => {
    const { year, slug } = parseSlugDate(post.id);
    return {
      params: {
        collection: post.collection,
        year,
        slug,
      },
      props: post,
    };
  });
}

const post = Astro.props;
const { Content } = await render(post);

const formattedDate = parseSlugDate(post.id).formattedDate;
const identifier = createMD5Hash(post.id.split("-").slice(3).join(" "));
const firstParagraph = getFirstParagraph(
  await markdownToHtml(post.body!),
  true,
)!;
const description =
  firstParagraph.length > 300
    ? firstParagraph.slice(0, 300) + "..."
    : firstParagraph;
---

<BlogPage
  date={formattedDate}
  title={post.data.title}
  description={description}
  tags={post.data.tags}
  tldr={post.data.tldr}
  image={post.data.image}
>
  <Content />
  <Disqus identifier={identifier} />
</BlogPage>
